<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ADMIN PAGE | TUP - Cavite</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet" />
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <!-- Font Awesome for Social Media Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


  <!-- External CSS -->
  <link rel="stylesheet" href="admin-homepage.css" />
</head>
<body>
  <div class="adminpage">
    <img class="Navbar" src="Navbar.png" />
    <div class="Line1"></div>
    <div class="Line2"></div>

    <div class="career-button slide-in" onclick="window.location.href='career-posting.html'">
      <div class="content"><div class="state-layer"><div class="hover-underline1">CAREER</div></div></div>
    </div>
        <div class="event-button slide-in" onclick="window.location.href='event-posting.html'">
      <div class="content"><div class="state-layer"><div class="hover-underline1">EVENT</div></div></div>
    </div>

    <div class="gallery-button slide-in" id="galleryBtn">
      <div class="content"><div class="state-layer"><div class="hover-underline1">GALLERY</div></div></div>
    </div>

    <!-- Modal for gallery -->
    <div class="gallery-modal" id="galleryModal">
      <div class="gallery-content">
        <button id="closeGallery" class="gallery-close">&times;</button>
        <h2>Gallery Posting "25 Picture per post" </h2>

        <form id="uploadForm" class="upload-form">
          <label>Select Images:</label>
          <input type="file" name="images" multiple accept="image/*" required />
          <button type="submit">Upload Images</button>
        </form>

        <div class="gallery-grid" id="galleryGrid"></div>
      </div>
    </div>

    <button id="signOutBtn" class="sign-out-button slide-in">
      <div class="content"><div class="state-layer"><div class="hover-underline1">SIGN-OUT</div></div></div>
    </button>

    <div id="loader-wrapper">
      <div class="loader-content">
          <span class="loading-span">T</span>
          <span class="loading-span2">ECHNOLOGICAL</span>
          <span class="loading-span">U</span>
          <span class="loading-span2">NIVERSITY OF THE</span>
          <span class="loading-span">P</span>
          <span class="loading-span2">HILIPPINES - </span>
          <span class="loading-span">C</span>
          <span class="loading-span2">AVITE</span>

        <div class="progress-container">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="percentage" id="percentage">0%</div>
        <div class="footer-text">LOADING PLEASE WAIT</div>
      </div>
    </div>


    <a href="admin-homepage.html">
      <img class="Logo" src="Logo.png" alt="University Logo" />
    </a>

    <div class="a-l-u-m-n-i slide-in">
      <span class="a-l-u-m-n-i-span">A</span>
      <span class="a-l-u-m-n-i-span2">l u m n i</span>
      <span class="a-l-u-m-n-i-span">C</span>
      <span class="a-l-u-m-n-i-span2">o o r d i n a t o r</span>
    </div>

    <div class="technological-university-of-the-philippines-cavite">
      TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES – CAVITE
    </div>

    <!-- Facebook Page Plugin -->
    <div class="fb-wrapper">
      <iframe 
        src="https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2FTUPCAA&tabs=timeline&width=340&height=500&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true"
        width="340" 
        height="500" 
        style="border:none; overflow:hidden;" 
        scrolling="no" 
        frameborder="0" 
        allowfullscreen="true" 
        allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
      </iframe>
    </div>

    <!-- TUPCAVITE Page -->
    <div class="fb-wrapper2">
      <iframe 
        src="https://www.facebook.com/plugins/page.php?href=https%3A%2F%2Fwww.facebook.com%2Ftupcavite.edu.ph&tabs=timeline&width=340&height=500&small_header=false&adapt_container_width=true&hide_cover=false&show_facepile=true"
        width="340" 
        height="500" 
        style="border:none; overflow:hidden;" 
        scrolling="no" 
        frameborder="0" 
        allowfullscreen="true" 
        allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
      </iframe>
    </div>

    <div class="announcement-box">
      <h3>ID Announcements</h3>
      <div class="announcement-list" id="idAnnouncementList">
        Loading...
      </div>
    </div>

    <div id="confirmModal" class="confirm-modal hidden">
      <div class="confirm-box">
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirm-actions">
          <button id="confirmYes">Yes</button>
          <button id="confirmNo">No</button>
        </div>
      </div>
    </div>

    <div class="announcement-box2">
      <h3>Events Announcements</h3>
      <div class="announcement-list" id="eventList">
        Loading...
      </div>
    </div>

    <div class="career-box">
      <h3>Career Opportunities</h3>
      <div class="career-list" id="careerList">
        Loading...
      </div>
    </div>

    <!-- Slideshow Section -->
    <div class="slideshow-container zoom-in">
      <img class="slideshow-image" src="Grad1.png" alt="Grad 1" />
      <img class="slideshow-image" src="Grad2.png" alt="Grad 2" />
      <img class="slideshow-image" src="Grad3.png" alt="Grad 3" />
      <img class="slideshow-image" src="Grad4.png" alt="Grad 4" />
      <img class="slideshow-image" src="Grad5.png" alt="Grad 5" />
      <img class="slideshow-image" src="Grad6.png" alt="Grad 6" />
      <img class="slideshow-image" src="Grad7.png" alt="Grad 7" />
      <img class="slideshow-image" src="Grad8.png" alt="Grad 8" />
    </div>

    <div class="commencement-description zoom-in">
      <h2 class="school-name">Technological University of the Philippines - Cavite</h2>
      <h3 class="event-title">40th <span>COMMENCEMENT EXERCISE</span></h3>
      <p class="description">
        Here are some snaps from the 40th Commencement Exercise at the Philippine International Convention Center on July 31, 2024.
        See the magical moments of every TUPCians who reached the end of their college journey.
        <br><br>
        <strong>Photos by:</strong> Photo X Media<br>
        <strong>Words by:</strong> Karen Pet Pabrowada
      </p>
    </div>
  </div>

  <div class="selection-container slide-in">
    <button type="hover-underline1" class="select-trigger" onclick="toggleDropdown()">DATA MANAGEMENT ▾</button>
    <div class="dropdown-menu" id="dropdownMenu">
      <div class="hover-underline1" onclick="navigateTo('alumni-Database.html')">Alumni Database</div>
      <div class="hover-underline1" onclick="navigateTo('jobs-response.html')">Jobs Response</div>
      <div class="hover-underline1" onclick="navigateTo('data-registration.html')">Registration</div>
      <div class="hover-underline1" onclick="navigateTo('admin-id.html')">ID Request</div>
      <div class="hover-underline1" onclick="navigateTo('event-registration.html')">Event Registration</div>
      <div class="hover-underline1" onclick="navigateTo('admin-employer.html')">Employer Registration</div>
    </div>
  </div>

  <div id="inboxPanel" class="modern-inbox">
    <div class="inbox-header">Admin Inbox</div>
    <div id="inboxContentList" class="inbox-list"></div>
    <div class="inbox-footer">
      <button id="clearInboxBtn">Clear All</button>
    </div>
  </div>

  <div id="notificationToggle" class="admin-notification-wrapper">
    <i class="fas fa-bell"></i>
    <span id="inboxBadge" class="notif-badge">0</span>
  </div>

  <div id="confirmationModal" class="inbox-confirm-modal hidden">
    <div class="inbox-modal-content">
      <div class="inbox-modal-header">Confirm Clear All</div>
      <div class="inbox-modal-body">Are you sure you want to clear all notifications?</div>
      <div class="inbox-modal-footer">
        <button id="confirmYesBtn" class="inbox-modal-btn yes">Yes</button>
        <button id="confirmNoBtn" class="inbox-modal-btn no">No</button>
      </div>
    </div>
  </div>


  
  <!-- Trigger Button -->
  <div class="id-post-button slide-in" id="idPostBtn">
    <div class="content"><div class="state-layer"><div class="hover-underline1">ID ANNOUNCEMENT</div></div></div>
  </div>

  <!-- Modal -->
  <div id="idPostModal" class="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeIDPostModal()">&times;</span>
      <h2 class="modal-title">Post ID Announcement</h2>
      <form id="idPostForm" class="modal-form">
        <label>Title:</label>
        <input type="text" name="title" required>

        <label>Description:</label>
        <textarea name="description" rows="4" required></textarea>

        <button type="submit" class="submit-btn">📩 Post Announcement</button>
      </form>
      <div id="idPostResult" class="result-message"></div>
    </div>
  </div>


  <!-- Contact Section -->
    <div class="contact-section">
      </a>
    </div>

  <!-- External JavaScript -->
<!-- Load external scripts -->
<script src="Homeslideshow.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script type="module">
  import { setupSignOut } from './sign-out.js';
  setupSignOut('admin');  // Restrict access to admin
</script>

<!-- Main Application Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  enforceAdminRole();
  initLoader();
  initDropdown();
  initContactObserver();
  initGallery();
  loadIdAnnouncements();
  loadEvents();
  loadCareers();
  initIDPostModal();
  initNotificationSystem();
});

function enforceAdminRole() {
  if (sessionStorage.getItem('userRole') !== 'admin') {
    window.location.href = 'homepage.html';
  }
}

function navigateTo(url) {
  window.location.href = url;
}

function initLoader() {
  let pct = 80;
  const loader = document.getElementById("loader-wrapper"),
        bar = document.getElementById("progress-bar"),
        pctEl = document.getElementById("percentage");

  const iv = setInterval(() => {
    if (pct < 100) {
      pct++;
      bar.style.width = pct + "%";
      pctEl.textContent = pct + "%";
    } else {
      clearInterval(iv);
      loader.style.display = "none";
    }
  }, 30);
}

function initDropdown() {
  const menu = document.getElementById('dropdownMenu');
  document.querySelector('.select-trigger')?.addEventListener('click', () => {
    menu.classList.toggle('show');
  });

  window.addEventListener('click', e => {
    if (!menu.contains(e.target) && !e.target.closest('.select-trigger')) {
      menu.classList.remove('show');
    }
  });
}

function initContactObserver() {
  const contactSection = document.querySelector('.contact-section');
  if (!contactSection) return;

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      contactSection.classList.toggle('slide-up', entry.isIntersecting);
      contactSection.classList.toggle('slide-down', !entry.isIntersecting);
    });
  }, { threshold: 0.1 });

  observer.observe(contactSection);
}

// Gallery Logic
function initGallery() {
  const btn = document.getElementById('galleryBtn');
  const modal = document.getElementById('galleryModal');
  const close = document.getElementById('closeGallery');
  const grid = document.getElementById('galleryGrid');
  const form = document.getElementById('uploadForm');

  btn?.addEventListener('click', () => {
    modal.style.display = 'flex';
    loadGallery(grid);
  });
  close?.addEventListener('click', () => modal.style.display = 'none');

  form?.addEventListener('submit', async e => {
    e.preventDefault();
    const fd = new FormData();
    [...form.elements['images'].files].forEach(f => fd.append('images', f));
    if (fd.has('images')) {
      const res = await fetch('/api/gallery/add-multiple', { method: 'POST', body: fd });
      const json = await res.json();
      if (res.ok) {
        form.reset();
        loadGallery(grid);
      } else alert('Upload failed: ' + (json.error || 'Unknown error'));
    } else alert('No images selected');
  });
}

async function loadGallery(container) {
  try {
    const res = await fetch('/api/gallery');
    if (!res.ok) throw new Error(await res.text());
    const { items } = await res.json();

    container.innerHTML = items.map(it => `
      <div class="gallery-item">
        <img src="${it.image}" alt="Gallery image">
        <button onclick="deleteImage(${it.id})">🗑️</button>
        <div class="gallery-date">${new Date(it.datePosted).toLocaleString()}</div>
      </div>
    `).join('');
  } catch (err) {
    alert('Failed to load gallery: ' + err.message);
  }
}

async function deleteImage(id) {
  if (confirm('Delete this image?')) {
    const res = await fetch(`/api/gallery/${id}`, { method: 'DELETE' });
    if (res.ok) loadGallery(document.getElementById('galleryGrid'));
    else alert('Delete failed');
  }
}

// ID Announcements
async function loadIdAnnouncements() {
  const container = document.getElementById('idAnnouncementList');
  container.innerHTML = 'Loading...';
  try {
    const res = await fetch('/api/admin/id-announcements');
    const { announcements } = await res.json();
    container.innerHTML = announcements.length ? announcements.map(a => `
      <div class="event-card" data-id="${a.id}">
        <div class="event-header">
          <span class="badge">ID ANNOUNCEMENT</span>
          <span class="posted-date">Posted: ${new Date(a.datePosted).toLocaleDateString()}</span>
        </div>
        <div class="event-title">${a.title}</div>
        <p>${a.description}</p>
        <button onclick="deleteAnnouncement(${a.id})" class="delete-btn">🗑️ Delete</button>
      </div>
    `).join('') : '<div>No announcements found.</div>';
  } catch (err) {
    container.innerHTML = '<div class="error">❌ Failed to load announcements</div>';
  }
}

async function deleteAnnouncement(id) {
  showConfirm('❗ Are you sure you want to delete this announcement?', async () => {
    const res = await fetch(`/api/admin/id-announcement/${id}`, { method: 'DELETE' });
    if (res.ok) {
      document.querySelector(`.event-card[data-id="${id}"]`)?.remove();
      showToast('✅ Deleted!');
    } else {
      showToast('❌ Failed to delete.', true);
    }
  });
}

function initIDPostModal() {
  document.getElementById('idPostBtn')?.addEventListener('click', () => {
    document.getElementById('idPostModal').style.display = 'flex';
  });

  document.getElementById('idPostForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Form data being sent:', data); // Debug log
    
    // Validate on frontend too
    if (!data.title || !data.description || data.title.trim() === '' || data.description.trim() === '') {
      document.getElementById('idPostResult').textContent = '❌ Please fill in all fields';
      return;
    }

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Posting...';
    submitBtn.disabled = true;

    try {
      const res = await fetch('/api/admin/id-announcement', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      
      console.log('Server response:', result); // Debug log
      
      document.getElementById('idPostResult').textContent = res.ok
        ? '✅ Announcement Posted!'
        : `❌ Error: ${result.error || 'Failed to post'}`;

      if (res.ok) {
        setTimeout(() => {
          closeIDPostModal();
          loadIdAnnouncements(); // Refresh the announcements list
        }, 2000);
      }
    } catch (error) {
      console.error('Network error:', error);
      document.getElementById('idPostResult').textContent = '❌ Network error. Please try again.';
    } finally {
      // Restore button state
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
}

function closeIDPostModal() {
  document.getElementById('idPostModal').style.display = 'none';
  document.getElementById('idPostForm').reset();
  document.getElementById('idPostResult').textContent = '';
}

// Events & Careers
async function loadEvents() {
  const container = document.getElementById('eventList');
  try {
    const res = await fetch('/api/events');
    const { events } = await res.json();
    container.innerHTML = events.map(e => `
      <div class="event-card">
        <div class="event-header">
          <span class="badge">EVENT ANNOUNCEMENT</span>
          <span class="posted-date">Posted: ${new Date(e.datePosted).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
        </div>
        <div class="event-title">${e.title}</div>
      </div>
    `).join('') || '<div>No announcements found.</div>';
  } catch {
    container.innerHTML = '<div class="error">❌ Failed to load events</div>';
  }
}

async function loadCareers() {
  const listContainer = document.getElementById('careerList');
  try {
    const res = await fetch('/api/careers');
    const { careers } = await res.json();
    listContainer.innerHTML = careers.slice(0, 10).map(c => `
      <div class="career-card">
        <div class="career-header"><span class="career-badge">CAREER</span> Posted: ${new Date(c.datePosted).toLocaleDateString()}</div>
        <div class="career-title">${c.title}</div>
      </div>
    `).join('') || '<div>No announcements found.</div>';
  } catch {
    listContainer.innerHTML = '❌ Failed to load careers';
  }
}

// Confirm Dialog
function showConfirm(message, onConfirm) {
  const modal = document.getElementById('confirmModal');
  document.getElementById('confirmMessage').textContent = message;
  modal.classList.remove('hidden');

  document.getElementById('confirmYes').onclick = () => {
    modal.classList.add('hidden');
    onConfirm();
  };
  document.getElementById('confirmNo').onclick = () => {
    modal.classList.add('hidden');
  };
}

// Notification System
function initNotificationSystem() {
  const inboxList = document.getElementById('inboxContentList');
  const badge = document.getElementById('inboxBadge');
  const bell = document.getElementById('notificationToggle');
  const panel = document.getElementById('inboxPanel');
  const clearBtn = document.getElementById('clearInboxBtn');

  bell?.addEventListener('click', () => panel.classList.toggle('show'));

  clearBtn?.addEventListener('click', () => {
    document.getElementById('confirmationModal').classList.remove('hidden');
  });

  document.getElementById('confirmYesBtn').onclick = () => {
    fetch('/api/notifications/clear', { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          inboxList.innerHTML = '';
          updateBadge();
        }
        document.getElementById('confirmationModal').classList.add('hidden');
      });
  };

  document.getElementById('confirmNoBtn').onclick = () => {
    document.getElementById('confirmationModal').classList.add('hidden');
  };

  function renderNotification(notif) {
    const item = document.createElement('div');
    item.className = 'inbox-item';
    item.innerHTML = `
      <div class="inbox-item-icon"><i class="fas fa-bell"></i></div>
      <div class="inbox-item-text clickable">
        <div class="inbox-item-title">
          ${notif.name} <span class="inbox-item-time">${new Date(notif.createdAt).toLocaleTimeString()}</span>
        </div>
        <div>${notif.message}</div>
      </div>
    `;
    item.addEventListener('click', () => {
      fetch(`/api/notifications/${notif.id}`, { method: 'DELETE' })
        .then(() => {
          item.remove();
          updateBadge();
          window.location.href = notif.link;
        });
    });
    inboxList.prepend(item);
    updateBadge();
  }

  function updateBadge() {
    const count = inboxList.querySelectorAll('.inbox-item').length;
    badge.textContent = count;
    badge.style.display = count > 0 ? 'inline-block' : 'none';
  }

  fetch('/api/admin/inbox')
    .then(res => res.json())
    .then(data => data.forEach(renderNotification));

  const socket = io();
  socket.on('newNotification', renderNotification);
}

</script>
</body>
</head>
</html>